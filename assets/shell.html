<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
	<div id="root"></div>

	<script>
		/**
		 * @param {KeyboardEvent} event
		 */
		function handleKeypress(event) {
			if (event.key === 'F11') {
				console.log('F11 key pressed');
				markview_toggle_fullscreen()
			}
		}

		// https://stackoverflow.com/questions/30106476/using-javascripts-atob-to-decode-base64-doesnt-properly-decode-utf-8-strings
		function decodeBase64(base64) {
			const text = atob(base64);
			const length = text.length;
			const bytes = new Uint8Array(length);
			for (let i = 0; i < length; i++) {
				bytes[i] = text.charCodeAt(i);
			}
			const decoder = new TextDecoder(); // default is utf-8
			return decoder.decode(bytes);
		}

		/**
		 * @param {PointerEvent} e
		 */
		function interceptClickEvent(e) {
			const target = e.target || e.srcElement;
			let href = '';

			if (target.tagName === 'A') {
				href = target.getAttribute('href');
			} else if (target.tagName === 'IMG') {
				href = target.parentElement.getAttribute('href');
			}

			if (!href || href.startsWith('#')) {
				return
			}

			e.preventDefault();

			const fullUrl = new URL(href, 'file:');

			if (href.endsWith('.md') && (fullUrl.protocol === 'file:')) {
				markview_open_file(href.startsWith('file://')? href.slice(7): href)
			} else if (fullUrl.protocol == 'http:' || fullUrl.protocol == 'https:') {
				// TODO: ask program to open in defaylt browser
			}
		}

		function markview_api_apply_css_from_base64(base64Content) {
			const style = document.createElement('style');

			style.textContent = decodeBase64(base64Content);

			document.head.appendChild(style);
		}

		function markview_api_render_html(base64Content) {
			const decodedContent = decodeBase64(base64Content);

			if (typeof DOMPurify === 'undefined') {
				window.root.innerHTML = '<h1>No DOMPurify found. Could be vulnerable to script injection. Please contact the author</h1>'
			} else {
				const cleanHtml = DOMPurify.sanitize(decodedContent)
				window.root.innerHTML = cleanHtml

				Prism.highlightAll()
			}
		}

		document.addEventListener('keydown', (event) => console.log(event.target));
		document.addEventListener('click', interceptClickEvent);

		// hide the webview widget so we can capture events
		document.addEventListener("dragover", (e) => {
			e.preventDefault();
			if (e.target.tagName === 'HTML') {
				markview_hide_webview();
			}
		})

		document.addEventListener("drop", (e) => e.preventDefault());
	</script>
</body>
</html>
